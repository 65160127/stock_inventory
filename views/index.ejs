<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Stock Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden">

    <%- include('partials/header') %>

    <main class="flex-1 p-8 overflow-y-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h2 class="text-3xl font-bold text-slate-800">ภาพรวมสต็อก</h2>
                <p class="text-slate-400">ตรวจสอบสต็อกสินค้าและการเบิกจ่ายแบบรวดเร็ว</p>
                
                <div class="mt-4 flex gap-2">
                    <button onclick="switchView('table')" id="btnTable" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-md transition">
                        <i class="fas fa-list mr-2"></i>มุมมองตาราง
                    </button>
                    <button onclick="switchView('grid')" id="btnGrid" class="px-4 py-2 bg-white text-slate-500 border rounded-lg text-sm font-bold hover:bg-slate-50 transition">
                        <i class="fas fa-th-large mr-2"></i>มุมมอง Card
                    </button>                  
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative">
                     <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                     <input type="text" id="searchInput" onkeyup="applyAllFilters()" placeholder="ค้นหารหัสสินค้า..." 
                     class="pl-10 pr-4 py-2 border rounded-full w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <form action="/api/products/upload" method="POST" enctype="multipart/form-data" class="flex items-center gap-2">
                    <input type="file" name="file" class="hidden" id="excelUpload" onchange="this.form.submit()">
                    <label for="excelUpload" class="cursor-pointer bg-emerald-100 text-emerald-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-emerald-200 transition">
                        <i class="fas fa-file-import mr-2"></i>นำเข้ายอด (Excel)
                    </label>
                </form>
            </div>
        </header>

        <div id="filterBarContainer" class="mb-6 bg-white p-4 rounded-2xl border shadow-sm flex flex-wrap gap-6 items-center">           
            <div class="flex items-center gap-2">
                <span class="text-sm font-bold text-slate-500">Supp Code:</span>
                <select id="suppFilter" onchange="applyAllFilters()" class="p-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50">
                    <option value="">ทั้งหมด (All)</option>
                    <% [...new Set(products.map(p => p.supp_code))].sort().forEach(supp => { %>
                        <option value="<%= supp %>"><%= supp %></option>
                    <% }); %>
                </select>
            </div>

            <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                <button onclick="setStatusAndFilter('all')" id="statusAll" class="filter-status-btn px-4 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm transition-all">ทั้งหมด</button>
                <button onclick="setStatusAndFilter('normal')" id="statusNormal" class="filter-status-btn px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:bg-white transition-all">สต็อกปกติ</button>
                <button onclick="setStatusAndFilter('low')" id="statusLow" class="filter-status-btn px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:bg-white transition-all">ต้องเติม</button>
                <button onclick="setStatusAndFilter('over')" id="statusOver" class="filter-status-btn px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:bg-white transition-all">ของล้น</button>
            </div>

            <button onclick="location.reload()" class="ml-auto text-xs text-blue-600 hover:text-blue-800 font-medium">
                <i class="fas fa-sync-alt mr-1"></i> ล้างการกรอง
            </button>
        </div>

        <div id="gridView" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <% products.forEach(product => { %>
                <div onclick="openModal('<%= product.box_list %>', <%= product.stock %>, <%= product.min_stock %>)" 
                     class="product-item bg-white p-6 rounded-3xl border shadow-sm relative transition hover:shadow-md cursor-pointer group"
                     data-name="<%= product.box_list.toLowerCase() %>"
                     data-supp="<%= product.supp_code %>"
                     data-stock="<%= product.stock %>"
                     data-min="<%= product.min_stock %>"
                     data-max="<%= product.max_stock %>">
                    
                    <% if (product.stock <= product.min_stock) { %>
                        <div class="absolute top-6 right-6 text-red-500 animate-pulse">
                            <i class="fas fa-exclamation-circle text-xl"></i>
                        </div>
                    <% } else if (product.max_stock && product.stock > product.max_stock) { %>
                        <div class="absolute top-6 right-6 text-orange-500">
                            <i class="fas fa-arrow-up-wide-short text-xl"></i>
                        </div>
                    <% } %>

                    <h3 class="font-bold text-xl text-slate-800 mb-1"><%= product.box_list %></h3>
                    <p class="text-slate-400 text-sm mb-6 uppercase tracking-wide">Supp: <%= product.supp_code %></p>
                    <div class="flex justify-between items-end mt-4">
                        <div>
                            <p class="text-slate-400 text-xs font-semibold">คงเหลือ</p>
                            <span class="text-5xl font-black <%= product.stock <= product.min_stock ? 'text-red-500' : (product.max_stock && product.stock > product.max_stock ? 'text-orange-500' : 'text-blue-600') %>">
                                <%= product.stock %>
                            </span>
                        </div>
                        <div class="text-right">
                            <span class="bg-slate-100 px-3 py-1 rounded-full text-xs text-slate-500 font-bold tracking-tight uppercase">ใบ</span>
                            <p class="text-[10px] text-slate-400 mt-2 font-bold uppercase">MAX: <%= product.max_stock || '-' %></p>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>

        <div id="tableView" class="overflow-x-auto bg-white rounded-3xl border shadow-sm">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 border-b text-sm font-bold text-slate-600">
                    <tr>
                        <th class="p-4">Box List</th>
                        <th class="p-4">Supp Code</th>
                        <th class="p-4 text-center">คงเหลือ</th>
                        <th class="p-4 text-center">Min / Max</th>
                        <th class="p-4 text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    <% products.forEach(product => { %>
                        <tr class="table-row-item border-b hover:bg-slate-50 transition"
                            data-name="<%= product.box_list.toLowerCase() %>"
                            data-supp="<%= product.supp_code %>"
                            data-stock="<%= product.stock %>"
                            data-min="<%= product.min_stock %>"
                            data-max="<%= product.max_stock %>">
                            <td class="p-4 font-bold text-slate-800"><%= product.box_list %></td>
                            <td class="p-4 text-slate-500 uppercase"><%= product.supp_code %></td>
                            <td class="p-4 text-center">
                                <span class="text-lg font-black <%= product.stock <= product.min_stock ? 'text-red-500' : (product.max_stock && product.stock > product.max_stock ? 'text-orange-500' : 'text-blue-600') %>">
                                    <%= product.stock %>
                                </span>
                            </td>
                            <td class="p-4 text-center text-slate-400 font-bold">
                                <%= product.min_stock %> / <%= product.max_stock || '-' %>
                            </td>
                            <td class="p-4 text-center">
                                <button onclick="openModal('<%= product.box_list %>', <%= product.stock %>, <%= product.min_stock %>)" 
                                        class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg hover:bg-blue-600 hover:text-white transition">
                                    <i class="fas fa-plus-minus mr-1"></i> ปรับสต็อก
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </main>

    <div id="stockModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 w-96 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold text-slate-800">จัดการสต็อก</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-500 mb-2">จำนวนที่ต้องการเปลี่ยนแปลง</label>
                <input type="number" id="stockAmount" value="0" min="1" class="w-full text-3xl font-bold p-4 bg-slate-50 border rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-center">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="handleStock('update')" class="bg-emerald-500 hover:bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-emerald-100 transition">
                    <i class="fas fa-plus-circle mr-2"></i>นำเข้า (+)
                </button>
                <button onclick="handleStock('use')" class="bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 transition">
                    <i class="fas fa-minus-circle mr-2"></i>ใช้งาน (-)
                </button>
            </div>
        </div>
    </div>

<script>
    // --- ตัวแปร Global ---
    var selectedBoxId = "";
    var currentStockValue = 0;
    var currentMinStock = 0;
    var currentStatusFilter = 'all';

    // --- ฟังก์ชันควบคุม View ---
    function switchView(view) {
        const grid = document.getElementById('gridView');
        const table = document.getElementById('tableView');
        const btnGrid = document.getElementById('btnGrid');
        const btnTable = document.getElementById('btnTable');

        if (view === 'grid') {
            grid.classList.remove('hidden');
            table.classList.add('hidden');
            btnGrid.className = "px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-md transition";
            btnTable.className = "px-4 py-2 bg-white text-slate-500 border rounded-lg text-sm font-bold hover:bg-slate-50 transition";
        } else {
            grid.classList.add('hidden');
            table.classList.remove('hidden');
            btnTable.className = "px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-md transition";
            btnGrid.className = "px-4 py-2 bg-white text-slate-500 border rounded-lg text-sm font-bold hover:bg-slate-50 transition";
        }
        applyAllFilters();
    }

    // --- ฟังก์ชัน Filter หลัก ---
    function setStatusAndFilter(status) {
        currentStatusFilter = status;
        document.querySelectorAll('.filter-status-btn').forEach(btn => {
            btn.className = "filter-status-btn px-4 py-1.5 rounded-lg text-sm font-bold text-slate-500 hover:bg-white transition-all";
        });
        const activeBtnId = 'status' + status.charAt(0).toUpperCase() + status.slice(1);
        document.getElementById(activeBtnId).className = "filter-status-btn px-4 py-1.5 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-sm transition-all";
        applyAllFilters();
    }

    function applyAllFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const suppValue = document.getElementById('suppFilter').value;
        const items = document.querySelectorAll('.product-item, .table-row-item');

        items.forEach(item => {
            const name = item.getAttribute('data-name') || "";
            const supp = item.getAttribute('data-supp') || "";
            const stock = parseInt(item.getAttribute('data-stock')) || 0;
            const min = parseInt(item.getAttribute('data-min')) || 0;
            const max = parseInt(item.getAttribute('data-max')) || 999999;

            const matchSearch = name.includes(searchText);
            const matchSupp = (suppValue === "" || supp === suppValue);
            
            let matchStatus = true;
            if (currentStatusFilter === 'normal') matchStatus = (stock > min && stock <= max);
            else if (currentStatusFilter === 'low') matchStatus = (stock <= min);
            else if (currentStatusFilter === 'over') matchStatus = (stock > max);

            if (matchSearch && matchSupp && matchStatus) {
                const displayType = item.classList.contains('table-row-item') ? 'table-row' : 'block';
                item.style.setProperty('display', displayType, 'important');
            } else {
                item.style.setProperty('display', 'none', 'important');
            }
        });
    }

    // --- ฟังก์ชันจัดการสต็อก ---
    function openModal(boxId, stock, min) {
        selectedBoxId = boxId;
        currentStockValue = parseInt(stock);
        currentMinStock = parseInt(min);
        document.getElementById('modalTitle').innerText = boxId;
        document.getElementById('stockModal').classList.remove('hidden');
        document.getElementById('stockAmount').value = 0;
        document.getElementById('stockAmount').focus();
    }

    function closeModal() { document.getElementById('stockModal').classList.add('hidden'); }

    async function handleStock(type) {
        const amount = parseInt(document.getElementById('stockAmount').value);
        if (!amount || amount <= 0) return alert('กรุณาระบุจำนวนที่ถูกต้อง');
        
        let newStock = (type === 'update') ? currentStockValue + amount : currentStockValue - amount;
        if (newStock < 0) return alert('สต็อกไม่เพียงพอต่อการใช้งาน');

        try {
            const response = await fetch('/api/products/update-stock', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    updates: [{ 
                        box_list: selectedBoxId, 
                        new_stock: newStock, 
                        new_min: currentMinStock,
                        amount: amount,
                        change_type: type === 'update' ? 'in' : 'use'
                    }] 
                })
            });
            if (response.ok) location.reload();
        } catch (err) { alert('เชื่อมต่อเซิร์ฟเวอร์ไม่ได้'); }
    }

    // --- ฟังก์ชัน Export ---
    function getExportData() {
        const data = [];
        document.querySelectorAll(".table-row-item").forEach(row => {
            if (row.style.display !== "none") {
                const cols = row.querySelectorAll("td");
                data.push({
                    "Box List": cols[0].innerText.trim(),
                    "Supp Code": cols[1].innerText.trim(),
                    "Stock": cols[2].innerText.trim(),
                    "Min/Max": cols[3].innerText.trim()
                });
            }
        });
        return data;
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = getExportData();
        if (data.length === 0) return alert("ไม่มีข้อมูลสำหรับการ Export");

        const body = data.map(i => [i["Box List"], i["Supp Code"], i["Stock"], i["Min/Max"]]);
        doc.text("Stock Report", 14, 15);
        doc.autoTable({ head: [['Box List', 'Supp Code', 'Stock', 'Min/Max']], body: body, startY: 20 });
        doc.save(`Stock_Inventory_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function exportToExcel() {
        const data = getExportData();
        if (data.length === 0) return alert("ไม่มีข้อมูลสำหรับการ Export");
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Inventory");
        XLSX.writeFile(wb, `Stock_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
</script>
</body>
</html>